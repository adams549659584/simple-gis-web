## 前言

随着前端开发趋于复杂化，地图（Gis）已经成为大多数系统必不可少的一部分，从最常见的 Gis 可视化（点、线、面、各种弹框、插值）到三维模型、场景模拟等。主流的智慧园区、智慧城市、孪生地球等基本都离不开 webGis 的开发。

通过这篇文章，能够有这些收获：

- 了解常见的 webGis 的实现方式
- 通过 leaflet、cesium、mapBox 创建地图 
- 在 leaflet、cesium、mapBox 通过不同方式绘制 Marker

文章中相关代码均已提交到 github，欢迎 star。

[代码地址](https://github.com/canyuegongzi/t-cli)

[预览地址](http://canyuegongzi.xyz/simple-gis-web/#/)

## 前端开发中的 Gis 方案

### 概述

#### leaflet

[leaflet官网](https://leafletjs.com/)

> Leaflet 是一个为建设移动设备友好的互动地图，而开发的现代的、开源的 JavaScript 库。它是由 Vladimir Agafonkin 带领一个专业贡献者团队开发，虽然代码仅有 38 KB，但它具有开发人员开发在线地图的大部分功能。

leaflet 可以通过简单的 Api 快速构建出简单的地图，结合其他的接口（Marker、 Popup、Icon、Polyline、Polygon等）即可快速实现点、线、面的绘制，社区中也有非常丰富的插件实现诸如热力图、插值、聚合、数据可视化等，需要注意一点 leaflet 只能实现 2D 地图。

#### cesium

[cesium官网](https://www.cesium.com/)

> Cesium是国外一个基于JavaScript编写的使用WebGL的地图引擎。Cesium支持3D,2D,2.5D形式的地图展示，可以自行绘制图形，高亮区域，并提供良好的触摸支持，且支持绝大多数的浏览器和mobile。

cesium 最重要的是可以实现三维效果，如果项目中有加载模型（类似园区模型）、场景模拟的需求时，可以选用 cesium 的方式实现（针对预算不足，无法采购其他商用方案时）。

#### mapBox

[mapbox官网](https://www.mapbox.com/)

> Mapbox GL JS 是一个 JavaScript 库，它使用 WebGL，以 vector tiles 和 Mapbox styles 为来源，将它们渲染成互动式地图。它是 Mapbox GL 生态系统的一部分，其中还包括 Mapbox Mobile，它是一个用 C++ 编写的兼容桌面和移动平台的渲染引擎。

mapbox 也可以快速的实现三维效果、加载模型，与 cesium 比较 mapbox 的 操作更加简单。

### 结论

以上只是列举了笔者常接触的几种技术方案，市面上也还有非常的多的解决方案，诸如 openlayers、百度地图Api、高德地图Api等。百度、高德提供的 sdk 也可以实现简单的 gis 效果，但不适用复杂效果的开发，笔者还是推荐对于复杂的地图效果使用专业 gis 解决方案。对于 leaflet、mapBox、cesium 从数据管理的方式做一下简单介绍：

1：leaflet 以图层的方式管理数据，一切的数据（点、线、面）都可以看做成独立的图层，开发者只需要对相应的图层执行挂载、卸载即可；
2：mapbox 以资源的方式管理数据，mapbox 最常见的数据管理可以通过加载标准的 geoJson 数据，然后在后续的地图操作中可以指定相对应的资源 id；
3：对于普通的前端开发，cesium 推荐使用实体的方案管理地图中的数据；

在 gis 代码编写过程中需要注意代码的优化，及时的卸载各种事件的监听、数据的销毁、否则极容易造成地图的卡顿，cesium 要尤为注意。

## 地图创建

代码为降低 Gis 功能和 vue、react 等这种前端框架之间的耦合关系，笔者将基础的 Gis 功能抽象出了基础的类。

### leaflet

#### 封装

```ts

export default class LeafletService implements BaseMap {

    // 瓦片地图地址
    private layerUrl: string = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png';
    
    constructor(props: LeafletInstanceOptions) {}

    /**
     * 初始化地图实例
     * @param type {MapTypeEnum} 地图类型
     * @param props {LeafletInstanceOptions} leaflet 初始化参数
     * @protected
     */
    public async initMapInstance(type: MapTypeEnum, props: LeafletInstanceOptions) {
        const mapInstanceCache: any = await CommonStore.getInstance('LEAFLET');
        if (mapInstanceCache) {
            return mapInstanceCache;
        }
        const map: Map = new Map(props.id, {
            crs: CRS.EPSG3857,   // 指定坐标系类型
            center: [30, 120],   // 地图中心点
            maxZoom: 18,         // 地图最大缩放级别
            minZoom: 5,          // 地图最小缩放级别
            maxBounds: latLngBounds(latLng(4, 73), latLng(54, 135)),
            zoom: 14,            // 默认缩放级别
            zoomControl: false,  // 是否显示放大缩小控件
            ...props
        });
        // 初始化一个 WMS 类型的 底图作为 leaflet 的地图 
        const titleLayer: TileLayer.WMS = new TileLayer.WMS(this.layerUrl,{
            format: 'image/png',
            layers: '全国县@全国县',
            transparent: true,
        });
        // 将底图添加到地图
        map.addLayer(titleLayer);
        // 缓存地图实例
        CommonStore.setInstance(type, map);
        return map;
    }
  
}
```

其中初始化地图采用 ```new Map``` 操作，其中第一个属性为 dom 容器 id，第二个参数类型见 leaflet 中 index.d.ts 中 MapOptions 描述；

#### 使用

```ts

const leafletProps: LeafletInstanceOptions = { id: 'leaflet-container'};
const instance = new LeafletService(leafletProps);
// 调用 地图初始化 leaflet
const map: any = await instance.initMapInstance('LEAFLET', { id: 'leaflet-container' });
// 地图实例挂载在 window, 后续方便操作
(window as any).leafletMap = map;
```

### cesium

#### 封装

```ts

export default class CesiumService implements BaseMap{
    constructor(props: CesiumInstanceOptions) {}

    /**
     * 初始化地图实例
     * @param type {MapTypeEnum} 地图类型
     * @param props {CesiumInstanceOptions} 初始化参数
     * @protected
     */
    public async initMapInstance(type: MapTypeEnum, props: CesiumInstanceOptions): Promise<any> {
        const mapInstanceCache: any = await CommonStore.getInstance('CESIUM');
        if (mapInstanceCache) {
            return mapInstanceCache;
        }
        // 实例化 cesium 地图
        const map: Viewer = new Viewer(props.id, {
            ...CesiumService.mergeOptions(props),
        });
        CommonStore.setInstance(type, map);
        // 启用地球照明
        map.scene.globe.enableLighting = !!props.enableLighting;
        // 影藏掉底部的logo
        const logo: HTMLElement = document.querySelector('.cesium-viewer-bottom') as HTMLElement;
        if (logo) {
            logo.style.display = 'none';
        }
        // 默认启用三维效果
        map.scene.morphTo3D(0.0);

        //关闭快速抗锯齿,文字清晰
        map.scene.postProcessStages.fxaa.enabled = false;
        map.scene.highDynamicRange = false;

        //禁止相机入地
        map.scene.screenSpaceCameraController.minimumZoomDistance = 2500;   //原来是100
        (map.scene.screenSpaceCameraController as any)._minimumZoomRate = 30000;   //设置相机缩小时的速率
        map.clock.onTick.addEventListener(() => {
            if (map.camera.pitch > 0) {
                map.scene.screenSpaceCameraController.enableTilt = false;
            }
        });
        return map;
    }

    /**
     * 合并参数
     * @param props
     * @private
     */
    private static mergeOptions(config: CesiumInstanceOptions): CesiumInstanceOptions {
        const defaultParams: CesiumInstanceOptions = {
            id: config.id,
            animation: config.animation || false,
            baseLayerPicker: config.baseLayerPicker || false,
            fullscreenButton: config.fullscreenButton || false,
            vrButton: config.vrButton || false,
            geocoder: config.geocoder || false,
            homeButton: config.homeButton || false,
            infoBox: config.infoBox || false,
            sceneModePicker: config.sceneModePicker || false,
            selectionIndicator: config.selectionIndicator || false,
            timeline: config.timeline || false,
            navigationHelpButton: config.navigationHelpButton || false,
            scene3DOnly: true,
            navigationInstructionsInitiallyVisible: false,
            showRenderLoopErrors: false,
            imageryProvider: (config.templateImageLayerUrl
                ? new UrlTemplateImageryProvider({
                    url: config.templateImageLayerUrl,
                })
                : null) as UrlTemplateImageryProvider,
        };
        return defaultParams;
    }
}
```

其中初始化地图采用 ```new Map``` 操作，其中第一个属性为 dom 容器 id，第二个参数类型见 cesium 中 index.d.ts 中 Viewer.ConstructorOptions 描述；

#### 使用

```ts

const cesiumProps: CesiumInstanceOptions = { id: 'cesium-container' };
const mapInstance = new CesiumService(cesiumProps);
// 初始化 cesium 地图
const map: Viewer = await this.cesiumMapInstance.initMapInstance('CESIUM', { id: 'cesium-container' });
// 地图实例挂载在 window, 后续方便操作
(window as any).cesiumMap = map;
```

### mapbox

#### 封装

```ts

export default class MapBoxService extends MapService {
    constructor(props: MapBoxInstanceOptions) {
        super();
    }
    /**
     * 初始化地图实例 {MapTypeEnum} 地图类型
     * @param type {MapBoxInstanceOptions} 地图初始化参数
     * @param props
     * @protected
     */
    public async initMapInstance(type: MapTypeEnum, props: MapBoxInstanceOptions) {
        const mapInstanceCache: any = await CommonStore.getInstance('MAPBOX');
        if (mapInstanceCache) {
            return mapInstanceCache;
        }
        const map: Map = new Map({
            container: props.id,
            style: 'mapbox://styles/mapbox/satellite-v9',   // mapbox 预设了几种样式
            center: [120, 30],
            pitch: 60,
            bearing: 80,
            maxZoom: 18,
            minZoom: 5,
            zoom: 9,
            // 需要去mapbox 官网注册应用获取token
            accessToken: 'pk.eyJ1IjoiY2FueXVlZ29uZ3ppIiwiYSI6ImNrcW9sOW5jajAxMDQyd3AzenlxNW80aHYifQ.0Nz5nOOxi4-qqzf2od3ZRA',
            ...props
        });
        CommonStore.setInstance(type, map);
        return map;

    }
}
```

其中初始化地图采用 ```new Map``` 操作，其中第一个属性为 dom 容器 id，第二个参数类型见 mapbox 中 index.d.ts 中 MapboxOptions 描述；

mapbox 预设的 style 如下：

1. mapbox://styles/mapbox/streets-v10
2. mapbox://styles/mapbox/outdoors-v10
3. mapbox://styles/mapbox/light-v9
4. mapbox://styles/mapbox/dark-v9
5. mapbox://styles/mapbox/satellite-v9
6. mapbox://styles/mapbox/satellite-streets-v10
7. mapbox://styles/mapbox/navigation-preview-day-v2
8. mapbox://styles/mapbox/navigation-preview-night-v2
9. mapbox://styles/mapbox/navigation-guidance-day-v2
10. mapbox://styles/mapbox/navigation-guidance-night-v2

#### 使用

```ts

const mapboxProps: MapBoxInstanceOptions = { id: 'mapbox-container' };
const instance = new MapBoxService(mapboxProps);
this.setMapInstance({ mapType: 'MAPBOX', instance });
const map: any = await instance.initMapInstance('MAPBOX', { id: 'mapbox-container' });
// 地图实例挂载在 window, 后续方便操作
(window as any).mapboxMap = map;

```

## 点位绘制

### leaflet
### cesium
### mapbox

## 最后

笔者是非专业 gis 专业，文章中如有专业性问题错误，欢迎各位大佬指正。

[代码地址](https://github.com/canyuegongzi/t-cli)

[预览地址](http://canyuegongzi.xyz/simple-gis-web/#/)
